Seleniumが検知されないようにする方法（自己責任）

tttttttttttttttttttttttt


## navigator.webdriverでSeleniumが検知される仕組み

### robot判定はnavigator.webdriverで可能。

Selenium等、webdriverが動くかどうかは、フロントエンドのjavascriptから、`navigator.webdriver`で検知できてしまいます。

```js
if (navigator.webdriver) {
    alert("Webdriverを検出しました");
}
```

【動作確認方法】`navigator.webdriver`を起動するサイトをわざわざクローリングしなくてもSeleniumの`execute_script`を使用することで
webdriverが検知されているかどうかを判断できます。

```js
driver.execute_script('return navigator.webdriver')
```

参考: 【Seleniumで偽装が無駄な理由】 https://qiita.com/MOSO1409/items/f5eba26a1cd893626bc7


### navigator.webdriver対策

`--disable-blink-features=AutomationControlled`を指定することで回避できるらしい。

```py
import time
from selenium import webdriver

options = webdriver.EdgeOptions()
options.add_argument("--disable-blink-features=AutomationControlled")

driver = webdriver.Edge(options=options)

def main():
    driver.get(url="http://localhost:3000")
    time.sleep(3)
    driver.execute_script('return navigator.webdriver')
    driver.quit()

if __name__ == '__main__':
    main()
```

参考: Seleniumが本当にバレバレなのか試してみた https://qiita.com/Guz9N9KLASTt/items/f62319a0f6ff00066f66

実行してみると、値が`False`に変わりました。




## HTTP Header からバレる可能性


### バレる例

`User-Agent`はそのままだとがっつりバレる

- サンプルコード

```py
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome import service


options = Options()
options.add_argument('--headless')
options.add_argument('--no-sandbox')
options.add_argument('--disable-dev-shm-usage')

driver = webdriver.Chrome(options=options)

driver.get('https://www.yahoo.co.jp/')
driver.save_screenshot(f"./screenshot.png")

print( driver.execute_script("return window.navigator.userAgent") )

driver.quit()
```

- 実行結果

> Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/126.0.6478.126 Safari/537.36




参考 : スクレイピングでアクセスブロックを回避するために注意すること
https://qiita.com/kobayashi-masayuki/items/0640a3dd5b12205f3b52


### 回避する例

1.ユーザーエージェントを変更するためのライブラリをインストールしておく。

```sh
pip3 install useragent-changer
```

2.`--user-agent`オプションを変更する。(今回はfirefoxを指定。)

```py
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome import service
from useragent_changer import UserAgent

PLATFORM= 'firefox'

options = Options()
options.add_argument('--headless')
options.add_argument('--no-sandbox')
options.add_argument('--disable-dev-shm-usage')
options.add_argument('--user-agent=' + UserAgent(PLATFORM).set())

driver = webdriver.Chrome(options=options)
driver.get('example.com')
driver.save_screenshot(f"./screenshot.png")

print( driver.execute_script("return window.navigator.userAgent") )

driver.quit()
```

実行結果

> Mozilla/5.0 (Windows NT 5.1; rv:51.0) Gecko/20100101 Firefox/51.0 SeaMonkey/2.48

ちなみにユーザーエージェントもランダムにした方が良さそう。








## headlessのオプションもバレる可能性がある


参考 : スクレイピングでアクセスブロックを回避するために注意すること
https://qiita.com/kobayashi-masayuki/items/0640a3dd5b12205f3b52












